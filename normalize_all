#!/usr/bin/env bash

find . -maxdepth 1 \( -name "*.ogg" -o -name "*.mkv" -o -name "*.mp4" -o -name "*.m4a" -o -name "*.opus" \) | while read fname; do
    echo "$fname"
    rm -f "$fname".log
    sem --lb -j $(grep -c ^processor /proc/cpuinfo) "normalize \"$fname\" >> \"$fname\".log 2>&1 && mkdir normalized_done -p && mv -n \"$fname\" normalized_done && rm -f \"$fname\".log"
    rm -f "$fname".log
done
sem --wait
wait